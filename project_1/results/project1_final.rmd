---
title: "BIOS 611 Project 1"
author: "William King"
date: "10/7/2019"
output: html_document
---
```{r include=FALSE}
library(tidyverse)
library(magrittr)
library(tibble)
library(ggplot2)
library(dplyr)
library(lubridate)

UMDsvc<-read_tsv("UMD_Services_Provided_20190719.tsv")

#found typo in client's file
#most 'food pounds' entries were 45, but one was 45121
UMDsvc$`Food Pounds`[68024]<-45

#convert "Date" column from characters to dates
UMDsvc<-UMDsvc %>%
  mutate(Date=as.Date(Date,"%m/%d/%Y"))

#clear out typos

UMDsvc %>%
filter(`Client File Number`==15000) %>%
  select(Date,`Food Pounds`) 

#it appears to be another typo: 5303 instead of 53
UMDsvc<-UMDsvc %>%
  arrange(-`Food Pounds`)
UMDsvc$`Food Pounds`[1]<-53

UMDsvc %>%
filter(`Client File Number`==14580) %>%
select(`Date`,`Food Pounds`)

#It appears '3738' was meant to be 37 or 38. 
#We replace with average, 37.5
UMDsvc$`Food Pounds`[2]<-37.5

UMDsvc %>%
  filter(`Client File Number`==12719) %>%
  select(`Date`,`Food Pounds`)

#again, we see a similar problem.
#We replace '1934' with the average, (19+34)/2= 26.5

UMDsvc$`Food Pounds`[3]<-26.5

UMDsvc %>%
  filter(`Client File Number`==13749) %>%
  select(`Date`,`Food Pounds`)

#again, we see a similar problem.
#We replace '1934' with the average, (19+34)/2= 26.5
UMDsvc$`Food Pounds`[4]<-26.5

UMDsvc %>%
  filter(`Client File Number`==16043) %>%
  select(`Date`,`Food Pounds`)

UMDsvc %>%
  filter(`Client File Number`==16393) %>%
  select(`Date`,`Food Pounds`)
#these observations are different.
#the Client File Numbers 16043 and 16393
#only have 1 entry for `Food Pounds`
UMDsvc %>%
  filter(`Client File Number`==1370) %>%
  select(`Date`,`Food Provided for`,`Food Pounds`)
#this observation also only has one non-NA entry for `Food Pounds`

UMDsvc %>%
  filter(`Client File Number`==10576) %>%
  select(`Date`,`Food Pounds`)
#this is more similar to the previous ones
#It seems reasonable to replace 1831 with the average again
#(18+31)/2=24.5
UMDsvc$`Food Pounds`[8]<-24.5

UMDsvc %>%
  filter(`Client File Number`==14151) %>%
  select(`Date`,`Food Pounds`)
#this is more similar to the previous ones
#It seems reasonable to replace 1831 with the average again
#(18+31)/2=24.5
UMDsvc$`Food Pounds`[9]<-24.5

UMDsvc %>%
  filter(`Client File Number`==14318) %>%
  select(`Date`,`Food Pounds`)
#This only has two entries but still likely a typo.
#Will replace 1831 with average of 24.5
UMDsvc$`Food Pounds`[10]<-24.5
#Client File Number 1180 has a large value for Food Pounds=1700
#And also large number for Food Provided for=200
UMDsvc %>%
  filter(`Client File Number`==1180) %>%
  select(`Date`,`Food Provided for`,`Food Pounds`)

UMDsvc %>%
  filter(`Client File Merge`==21180) %>%
  select(`Date`,`Food Provided for`,`Food Pounds`) 
#Will come back to this one.

#After looking at Food Provided for, can justify
#adjusting three previous examples, as they are likely typos

UMDsvc %>%
  filter(`Client File Number`==16043) %>%
  select(`Date`,`Food Pounds`)

UMDsvc$`Food Pounds`[5]<-26.5

UMDsvc %>%
  filter(`Client File Number`==16393) %>%
  select(`Date`,`Food Pounds`)

UMDsvc$`Food Pounds`[6]<-26.5

UMDsvc %>%
  filter(`Client File Number`==1370) %>%
  select(`Date`,`Food Provided for`,`Food Pounds`)

UMDsvc$`Food Pounds`[7]<-24.5

#Dates appear to be continuous going back until 1991.
#Then they begin to "jump" by 10 year intervals, all the way to 1931!
#Let's limit our analysis to the past 20 years.
#They will likely be more relevant anyways.

UMD.20yr<-UMDsvc %>%
  filter(Date>"2000-01-01" & Date<"2019-09-25")

#We can also split our data into different time periods for comparison

UMD.15yr<-UMD.20yr %>%
  filter(Date>"2005-01-01")
  
UMD.10yr<-UMD.15yr %>%
  filter(Date>"2010-01-01")

UMD.5yr<-UMD.10yr %>%
  filter(Date>"2015-01-01")

UMD.16.20yr<-anti_join(UMD.20yr,UMD.15yr)

UMD.11.15yr<-anti_join(UMD.15yr,UMD.10yr)

UMD.6.10yr<-anti_join(UMD.10yr,UMD.5yr)

UMD.16.20yr<-UMD.16.20yr %>%
  mutate(Period="2000-2004")

UMD.11.15yr<-UMD.11.15yr %>%
  mutate(Period="2005-2009")

UMD.6.10yr<-UMD.6.10yr %>%
  mutate(Period="2010-2014")

UMD.5yr<-UMD.5yr %>%
  mutate(Period="2015-2019")

UMD.20yr<-UMD.16.20yr %>%
  full_join(UMD.11.15yr) %>%
  full_join(UMD.6.10yr) %>%
  full_join(UMD.5yr)
#Food appears to be the variable with most complete data for analysis
#remove variables we will not use in this analysis
UMD.20yr <- UMD.20yr %>%
  select(-`Client File Merge`,-`Bus Tickets (Number of)`,
         -`Notes of Service`,-Referrals,-`Type of Bill Paid`,
         -`Payer of Support`,-`Field1`,-`Field2`,-`Field3`,
         -Diapers,-`School Kits`,-`Hygiene Kits`,-`Financial Support`
         )

UMD.20yr.dur<-UMD.20yr %>%
  group_by(`Client File Number`)%>%
  summarize(Duration=max(Date)-min(Date),Visits=n(),
            Frequency=as.numeric(Duration/Visits),
            `Food Pounds Per Visit`=sum(`Food Pounds`,na.rm=TRUE)/Visits,
            `Food Provided for Per Visit`=sum(`Food Provided for`,na.rm=TRUE)/Visits)
            

UMD.20yr<-left_join(UMD.20yr,UMD.20yr.dur)
```
Urban Ministries of Durham is a charitable organization that has been providing food, clothing and other services to homeless individuals in the Durham area for over 30 years.   

The social workers at UMD have been been recording much of their aid to clients in a database, which they have provided to us in a tsv file. All of the data for this project comes from this database. 

As they are an organization that first and foremost is about helping people, I believe we should begin our analysis with their clients. One particular area that we were told is of interest to UMD is the length of time that their clients receive assistance for. They would like to know if there are any noticeable patterns among those who only need aid for a short time, and those who continue to need it for an extended period. I hope to help them shed some light on this question.

After tidying the data and clearing up typos, I first look into how long different clients received assistance for. We limit our data to the years 2000-2019 as they are most relevant and complete.

Let's see if there are any patterns.  

```{r echo=FALSE}

ggplot(filter(UMD.20yr,Duration>0))+
  geom_histogram(mapping=aes(x=as.numeric(Duration),fill=Period),
                 binwidth=60)+
  facet_wrap(vars(Period))+
labs(title="Number of Clients by Duration Assisted", x="Duration",y="Number of Clients")

```
  
Some things we can notice right away: 

* Each time period has a big spike around 0, so most clients received aid only once.  

* The slope begins to level out around what appears to be 2 years.

* In general, the number of clients assisted looks to be increasing.

Considering the large number of clients who receive aid only once, it is worth looking at single-visit and repeat clients separately.


Let's look at the frequency of visit for repeat clients.  
```{r echo=FALSE}

ggplot(filter(UMD.20yr,Frequency>0 & Frequency<500))+
  geom_histogram(aes(x=Frequency,fill=Period),
                 binwidth=7)+
labs(title="Frequency of Assistance for Repeat Clients", x="Days per Visit",y="Number of Clients") +
  facet_wrap(vars(Period))


```
  
Here we can draw some useful observations about visit frequency:

* Most clients appear to receive assistance around once every 1-3 months (~30-90 days)  

* The number of clients who receive frequent assistance has increased significantly over the years.  

* The number of clients who receive very infrequent assistance seems to have slightly decreased.  
```{r echo=FALSE}
ggplot(filter(UMD.20yr,Duration==0),color=Period)+
  geom_bar(aes(x=Period,fill=Period))+
  theme(legend.position="none")+
  labs(y="Clients",title="Number of Single-Visit Clients by Period")
```
  
Here, we see that the number of single-visit clients increased by large numbers from 2004-2014, but has remained steady since 2014.

Let's have a look at what months these single-visits occur on most and least frequently.
```{r echo=FALSE}
ggplot(filter(UMD.20yr,Duration==0))+
  geom_bar(aes(x=month(Date,label=TRUE),fill=month(Date)))+
  theme(legend.position="none")+
  labs(x="Month",y="Visits",title="Visits per Month, 2000-2019")

ggplot(filter(UMD.20yr,Duration==0))+
  geom_bar(aes(x=month(Date,label=TRUE),fill=month(Date)))+
  theme(legend.position="none")+
  labs(x="Month",y="Visits",title="Visits per Month by Period")+
  facet_wrap(vars(Period))
```
  
Some observations:

* There are not extreme differences between months. 

* Summer consistently has a relatively high number of visits.  

* Spring consistently has a relatively low number of visits.  

* The overall increasing trend is more noticeable than any month-to-month differences.


From our first graphs on assistance duration for clients, it appeared that the durations could be divided into several strata:
1. 1 Day  
2. 2 Days-6 Months  
3. 6 Months-1 Year  
4. 1-2 Years  
5. 2-5 Years  
6. 5-10 Years
7. 10+ Years
```{r include=FALSE}

#Let's split the Duration into several categories
#The histogram suggested the duration of assistance 
#Could be split into a few relatively similar groups

x<-tibble(UMD.20yr$Duration)

g<-"initialize"
for(i in 1:nrow(x)){
  if(x[i,1]==0){
    g[i]<-paste0("1 Day")
  } else if(x[i,1]>1 & x[i,1]<=183){
    g[i]<-paste0("2 Days-6 Months")
  } else if(x[i,1]>183 & x[i,1]<=365){
    g[i]<-paste0("6-12 Months")
  }else if(x[i,1]>365 & x[i,1]<=730){
    g[i]<-paste0("1-2 Years")
  }else if(x[i,1]>730 & x[i,1]<=1825){
    g[i]<-paste0("2-5 Years")
  }else if(x[i,1]>1825 & x[i,1]<=3650){
    g[i]<-paste0("5-10 Years")
  }else if(x[i,1]>3650){
    g[i]<-paste0("10+ Years")
  }
  else{
    NULL
  }
}

UMD.20yr<-UMD.20yr %>%
  mutate(`Time Assisted for`=g)

UMD.15yr<-UMD.20yr %>%
  filter(Date>"2005-01-01") 

UMD.10yr<-UMD.15yr %>%
  filter(Date>"2010-01-01") 
  
UMD.5yr<-UMD.10yr %>%
  filter(Date>"2015-01-01")
  
UMD.16.20yr<-anti_join(UMD.20yr,UMD.15yr)

UMD.11.15yr<-anti_join(UMD.15yr,UMD.10yr)

UMD.6.10yr<-anti_join(UMD.10yr,UMD.5yr)


```
```{r echo=FALSE,warning=FALSE}
dur.group.order<-c("1 Day","2 Days-6 Months","6-12 Months","1-2 Years","2-5 Years","5-10 Years","10+ Years")

ggplot(data=UMD.20yr,aes(x=`Time Assisted for`))+
  scale_x_discrete(limit=dur.group.order)+
  scale_fill_discrete(limit=dur.group.order)+
  geom_bar(aes(fill=`Time Assisted for`)) +
  facet_wrap(vars(Period)) +
  theme(axis.text.x=element_blank()) +
  labs(x="Assistance Duration",y="Number of Clients",
  title= "Clients' Duration of Assistance, 2000-2019")
```
  
Some observations:  

* 2-5 Years, 5-10 Years and 10+ Years have always been the three largest groups. This makes sense considering their wider time frame.

* Roughly an equal number of people receive help for one day as do for 2 days-6 months.  

* Those receiving help for 6-12 months, 1-2 years and 2-5 years have steadily increased in number.

* After increasing over the first three periods, the 5-10 Years and 10+ Years groups both decreased in the last period  

* 2-5 Years saw by far its biggest increase in the final period.

It would be helpful to analyze these groups further, to see if there are any differences in services provided that may be associated with longer or shorter periods of needing assistance.

From cursory analysis, the only variable that immediately shows any significant difference between these groups is Food Pounds.

```{r echo=FALSE, warning=FALSE}
ggplot(data=filter(UMD.20yr,`Food Pounds Per Visit` <75 & `Food Pounds Per Visit`>0),aes(x=`Time Assisted for`,
      y=`Food Pounds Per Visit`,fill=`Time Assisted for`))+ 
  scale_x_discrete(limit=dur.group.order)+
  scale_fill_discrete(limit=dur.group.order)+
  geom_boxplot()+
  theme(axis.text.x=element_blank()) +
  facet_wrap(vars(Period)) +
  labs(x="Assistance Duration")
```
  
One thing I notice is that the 1-day clients appear to receive slightly more food per visit than others.  

This could possibly suggest that clients who receive enough food on their first visit are less likely to need to return again. Alternatively, it could instead only be due to scarcity of resources that makes it difficult to give large amounts of food to clients over long periods of time. More analysis would be required to try to help answer this question.  

So far, we have recognized some patterns in the duration of assistance for clients. These are good starting points from which to continue further analysis in a number of potential directions.

At this point, I feel it would be helpful to speak directly with our clients at Urban Ministries to see how they feel about the information we have reviewed so far. Further analysis is definitely required to be able to draw many worthwhile conclusions, and it would be helpful to hear from them what directions they would like to go in.

